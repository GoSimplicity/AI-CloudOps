name: Release

on:
  push:
    tags:
      - 'v*'

env:
  GO_VERSION: '1.24.6'

jobs:
  release:
    name: Create Release & Source Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Create multi-environment source packages
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p dist
          
          # å®šä¹‰ç¯å¢ƒåˆ—è¡¨
          ENVIRONMENTS=("development" "production" "staging" "test")
          
          echo "ğŸš€ åˆ›å»ºå¤šç¯å¢ƒæºä»£ç åŒ…..."
          
          for env in "${ENVIRONMENTS[@]}"; do
            echo "ğŸ“¦ å‡†å¤‡ $env ç¯å¢ƒåŒ…..."
            
            # åˆ›å»ºç¯å¢ƒç‰¹å®šçš„ç›®å½•
            ENV_DIR="ai-cloudops-$env"
            mkdir -p "dist/$ENV_DIR"
            
            # å¤åˆ¶æ‰€æœ‰æºä»£ç æ–‡ä»¶
            rsync -av --exclude='.git' \
                     --exclude='dist' \
                     --exclude='bin' \
                     --exclude='tmp' \
                     --exclude='logs' \
                     --exclude='data' \
                     --exclude='.DS_Store' \
                     --exclude='*.log' \
                     --exclude='node_modules' \
                     --exclude='.env' \
                     . "dist/$ENV_DIR/"
            
            # æ ¹æ®ç¯å¢ƒé…ç½®ç›¸åº”çš„é…ç½®æ–‡ä»¶
            if [ -f "config/config.$env.yaml" ]; then
              cp "config/config.$env.yaml" "dist/$ENV_DIR/config/config.yaml"
              echo "âœ… ä½¿ç”¨ $env ç¯å¢ƒé…ç½®æ–‡ä»¶"
            else
              # å¦‚æœæ²¡æœ‰ç‰¹å®šç¯å¢ƒé…ç½®ï¼Œä½¿ç”¨å¼€å‘é…ç½®ä½œä¸ºé»˜è®¤
              if [ -f "config/config.development.yaml" ]; then
                cp "config/config.development.yaml" "dist/$ENV_DIR/config/config.yaml"
                echo "âš ï¸  ä½¿ç”¨å¼€å‘ç¯å¢ƒé…ç½®ä½œä¸º $env ç¯å¢ƒé»˜è®¤é…ç½®"
              fi
            fi
            
            # åˆ›å»ºç¯å¢ƒç‰¹å®šçš„README
            cat > "dist/$ENV_DIR/ENVIRONMENT.md" << EOF
          # AI-CloudOps - $env ç¯å¢ƒ

          ## ğŸŒ ç¯å¢ƒä¿¡æ¯
          - **ç¯å¢ƒç±»å‹**: $env
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Gitæäº¤**: ${{ github.sha }}

          ## ğŸš€ å¿«é€Ÿå¯åŠ¨

          ### 1. ç¯å¢ƒå‡†å¤‡
          \`\`\`bash
          # å®‰è£…Goä¾èµ–
          go mod download
          \`\`\`

          ### 2. é…ç½®ç¯å¢ƒ
          \`\`\`bash
          # å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
          cp env.example .env
          
          # ç¼–è¾‘ç¯å¢ƒå˜é‡
          vim .env
          \`\`\`

          ### 3. å¯åŠ¨æœåŠ¡
          \`\`\`bash
          # å¼€å‘æ¨¡å¼
          go run main.go
          
          # æˆ–ä½¿ç”¨Docker
          docker-compose up -d
          \`\`\`

          ## ğŸ“‹ ç¯å¢ƒç‰¹æ€§

          EOF
            
            # æ ¹æ®ç¯å¢ƒæ·»åŠ ç‰¹å®šè¯´æ˜
            case $env in
              "development")
                echo "- ğŸ”§ å¼€å‘è°ƒè¯•æ¨¡å¼" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ“Š è¯¦ç»†æ—¥å¿—è¾“å‡º" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ§ª çƒ­é‡è½½æ”¯æŒ" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ” è°ƒè¯•å·¥å…·é›†æˆ" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                ;;
              "production")
                echo "- ğŸš€ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ”’ å®‰å…¨é…ç½®å¼ºåŒ–" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ“ˆ æ€§èƒ½ç›‘æ§" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ’¾ æ•°æ®æŒä¹…åŒ–" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                ;;
              "staging")
                echo "- ğŸ­ é¢„å‘å¸ƒç¯å¢ƒ" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ§ª é›†æˆæµ‹è¯•" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ“Š æ€§èƒ½æµ‹è¯•" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ” è´¨é‡éªŒè¯" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                ;;
              "test")
                echo "- ğŸ§ª æµ‹è¯•ç¯å¢ƒ" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ¤– è‡ªåŠ¨åŒ–æµ‹è¯•" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ“ æµ‹è¯•æ•°æ®" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                echo "- ğŸ”„ æŒç»­é›†æˆ" >> "dist/$ENV_DIR/ENVIRONMENT.md"
                ;;
            esac
            
            echo "" >> "dist/$ENV_DIR/ENVIRONMENT.md"
            echo "## ğŸ“š ç›¸å…³é“¾æ¥" >> "dist/$ENV_DIR/ENVIRONMENT.md"
            echo "- [é¡¹ç›®ä¸»é¡µ](https://github.com/GoSimplicity/AI-CloudOps)" >> "dist/$ENV_DIR/ENVIRONMENT.md"
            echo "- [éƒ¨ç½²æ–‡æ¡£](https://github.com/GoSimplicity/AI-CloudOps#-å¿«é€Ÿå¼€å§‹-quick-start)" >> "dist/$ENV_DIR/ENVIRONMENT.md"
          done

      - name: Create compressed source packages
        run: |
          cd dist
          echo "ğŸ—œï¸ åˆ›å»ºå‹ç¼©åŒ…..."
          
          # ä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»ºzipåŒ…
          for dir in ai-cloudops-*; do
            if [ -d "$dir" ]; then
              echo "å‹ç¼© $dir ..."
              zip -r "${dir}.zip" "$dir" -x "*.DS_Store" "*/\.git/*"
              echo "âœ… åˆ›å»ºå®Œæˆ: ${dir}.zip"
            fi
          done
          
          # åˆ›å»ºå®Œæ•´æºä»£ç åŒ…
          echo "ğŸ“¦ åˆ›å»ºå®Œæ•´æºä»£ç åŒ…..."
          cd ..
          zip -r "dist/ai-cloudops-source-complete.zip" . \
            -x ".git/*" "dist/*" "bin/*" "tmp/*" "logs/*" "data/*" \
               ".DS_Store" "*.log" "node_modules/*" ".env"

      - name: Generate package info
        run: |
          cd dist
          echo "ğŸ“Š ç”ŸæˆåŒ…ä¿¡æ¯..."
          
          # åˆ›å»ºåŒ…ä¿¡æ¯æ–‡ä»¶
          cat > packages-info.txt << EOF
          AI-CloudOps ${{ github.ref_name }} - æºä»£ç åŒ…ä¿¡æ¯
          ===============================================
          
          æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Gitæäº¤: ${{ github.sha }}
          å‘å¸ƒç‰ˆæœ¬: ${{ github.ref_name }}
          
          ğŸ“¦ ç¯å¢ƒç‰¹å®šåŒ…:
          EOF
          
          for zip in ai-cloudops-*.zip; do
            if [ -f "$zip" ] && [ "$zip" != "ai-cloudops-source-complete.zip" ]; then
              size=$(ls -lh "$zip" | awk '{print $5}')
              env=$(echo "$zip" | sed 's/ai-cloudops-\(.*\)\.zip/\1/')
              echo "  - $zip ($size) - $env ç¯å¢ƒ" >> packages-info.txt
            fi
          done
          
          echo "" >> packages-info.txt
          echo "ğŸ“¦ å®Œæ•´æºä»£ç åŒ…:" >> packages-info.txt
          if [ -f "ai-cloudops-source-complete.zip" ]; then
            size=$(ls -lh "ai-cloudops-source-complete.zip" | awk '{print $5}')
            echo "  - ai-cloudops-source-complete.zip ($size) - å®Œæ•´æºä»£ç " >> packages-info.txt
          fi
          
          echo "" >> packages-info.txt
          echo "ğŸ”§ ä½¿ç”¨è¯´æ˜:" >> packages-info.txt
          echo "1. ä¸‹è½½å¯¹åº”ç¯å¢ƒçš„æºä»£ç åŒ…" >> packages-info.txt
          echo "2. è§£å‹åˆ°ç›®æ ‡ç›®å½•" >> packages-info.txt
          echo "3. å‚è€ƒ ENVIRONMENT.md è¿›è¡Œç¯å¢ƒé…ç½®" >> packages-info.txt
          echo "4. è¿è¡Œ 'go mod download' å®‰è£…ä¾èµ–" >> packages-info.txt
          echo "5. é…ç½® .env ç¯å¢ƒå˜é‡æ–‡ä»¶" >> packages-info.txt
          echo "6. è¿è¡Œ 'go run main.go' å¯åŠ¨æœåŠ¡" >> packages-info.txt
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          echo "" >> packages-info.txt
          echo "ğŸ” æ–‡ä»¶æ ¡éªŒå’Œ (SHA256):" >> packages-info.txt
          sha256sum *.zip >> packages-info.txt

      - name: Extract tag info
        id: tag_info
        run: |
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "tag_version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git tag --sort=-version:refname | head -2 | tail -1)
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          ## ğŸš€ AI-CloudOps ${{ steps.tag_info.outputs.tag_name }} - å¤šç¯å¢ƒæºä»£ç å‘å¸ƒ
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          $CHANGELOG
          
          ### ğŸ“¦ æºä»£ç åŒ…è¯´æ˜
          
          æœ¬æ¬¡å‘å¸ƒåŒ…å«é’ˆå¯¹ä¸åŒç¯å¢ƒä¼˜åŒ–çš„æºä»£ç åŒ…ï¼Œè¯·æ ¹æ®æ‚¨çš„éƒ¨ç½²ç¯å¢ƒé€‰æ‹©ï¼š
          
          #### ğŸŒ ç¯å¢ƒç‰¹å®šåŒ…
          - **ğŸ“¦ ai-cloudops-development.zip**: å¼€å‘ç¯å¢ƒ - åŒ…å«è°ƒè¯•é…ç½®å’Œå¼€å‘å·¥å…·
          - **ğŸ“¦ ai-cloudops-production.zip**: ç”Ÿäº§ç¯å¢ƒ - ä¼˜åŒ–é…ç½®ï¼Œå®‰å…¨å¼ºåŒ–
          - **ğŸ“¦ ai-cloudops-staging.zip**: é¢„å‘å¸ƒç¯å¢ƒ - é€‚ç”¨äºé›†æˆæµ‹è¯•
          - **ğŸ“¦ ai-cloudops-test.zip**: æµ‹è¯•ç¯å¢ƒ - åŒ…å«æµ‹è¯•é…ç½®å’Œæ•°æ®
          - **ğŸ“¦ ai-cloudops-source-complete.zip**: å®Œæ•´æºä»£ç åŒ… - åŒ…å«æ‰€æœ‰é…ç½®æ–‡ä»¶
          
          #### ğŸ”§ å¿«é€Ÿéƒ¨ç½²
          
          1. **ä¸‹è½½æºä»£ç åŒ…**
             \`\`\`bash
             # ä¸‹è½½å¯¹åº”ç¯å¢ƒçš„åŒ…
             wget https://github.com/GoSimplicity/AI-CloudOps/releases/download/${{ steps.tag_info.outputs.tag_name }}/ai-cloudops-production.zip
             \`\`\`
          
          2. **è§£å‹å¹¶é…ç½®**
             \`\`\`bash
             unzip ai-cloudops-production.zip
             cd ai-cloudops-production
             
             # æŸ¥çœ‹ç¯å¢ƒè¯´æ˜
             cat ENVIRONMENT.md
             \`\`\`
          
          3. **å®‰è£…ä¾èµ–**
             \`\`\`bash
             go mod download
             \`\`\`
          
          4. **é…ç½®ç¯å¢ƒå˜é‡**
             \`\`\`bash
             cp env.example .env
             # æ ¹æ®ç¯å¢ƒä¿®æ”¹ .env æ–‡ä»¶
             \`\`\`
          
          5. **å¯åŠ¨æœåŠ¡**
             \`\`\`bash
             # ç›´æ¥è¿è¡Œ
             go run main.go
             
             # æˆ–æ„å»ºåè¿è¡Œ
             go build -o ai-cloudops main.go
             ./ai-cloudops
             
             # æˆ–ä½¿ç”¨Docker
             docker-compose up -d
             \`\`\`
          
          ### âœ¨ ç¯å¢ƒç‰¹æ€§å¯¹æ¯”
          
          | ç¯å¢ƒ | æ—¥å¿—çº§åˆ« | æ€§èƒ½ä¼˜åŒ– | è°ƒè¯•æ”¯æŒ | ç›‘æ§é›†æˆ | é€‚ç”¨åœºæ™¯ |
          |------|---------|---------|---------|---------|---------|
          | Development | Debug | å…³é—­ | âœ… | åŸºç¡€ | æœ¬åœ°å¼€å‘ |
          | Test | Info | å…³é—­ | âœ… | å®Œæ•´ | è‡ªåŠ¨åŒ–æµ‹è¯• |
          | Staging | Warn | å¼€å¯ | éƒ¨åˆ† | å®Œæ•´ | é›†æˆæµ‹è¯• |
          | Production | Error | å¼€å¯ | å…³é—­ | å®Œæ•´ | ç”Ÿäº§éƒ¨ç½² |
          
          ### ğŸ“Š åŒ…ä¿¡æ¯
          
          æ¯ä¸ªç¯å¢ƒåŒ…éƒ½åŒ…å«ï¼š
          - âœ… å®Œæ•´æºä»£ç 
          - âœ… ç¯å¢ƒç‰¹å®šé…ç½®æ–‡ä»¶
          - âœ… éƒ¨ç½²è¯´æ˜æ–‡æ¡£ (ENVIRONMENT.md)
          - âœ… ä¾èµ–ç®¡ç†æ–‡ä»¶ (go.mod/go.sum)
          - âœ… Docker é…ç½®æ–‡ä»¶
          
          ### âœ… æ–‡ä»¶æ ¡éªŒ
          
          ä¸‹è½½ \`packages-info.txt\` æŸ¥çœ‹åŒ…è¯¦æƒ…å’Œæ ¡éªŒå’Œä¿¡æ¯ã€‚
          
          ### ğŸ“š ç›¸å…³æ–‡æ¡£
          
          - [ğŸ“– é¡¹ç›®ä¸»é¡µ](https://github.com/GoSimplicity/AI-CloudOps)
          - [ğŸš€ å¿«é€Ÿå¼€å§‹](https://github.com/GoSimplicity/AI-CloudOps#-å¿«é€Ÿå¼€å§‹-quick-start)
          - [ğŸ—ï¸ éƒ¨ç½²æŒ‡å—](https://github.com/GoSimplicity/AI-CloudOps/wiki)
          - [â“ é—®é¢˜åé¦ˆ](https://github.com/GoSimplicity/AI-CloudOps/issues)
          
          ### ğŸ” æ•…éšœæ’æŸ¥
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
          1. æŸ¥çœ‹å¯¹åº”ç¯å¢ƒçš„ ENVIRONMENT.md æ–‡æ¡£
          2. æ£€æŸ¥ .env ç¯å¢ƒå˜é‡é…ç½®
          3. ç¡®è®¤ Go ç‰ˆæœ¬ >= 1.24.6
          4. æŸ¥çœ‹é¡¹ç›® Issues æˆ–æäº¤æ–°é—®é¢˜
          
          ---
          
          ğŸ’¡ **æç¤º**: é¦–æ¬¡éƒ¨ç½²æ¨èä½¿ç”¨ development ç¯å¢ƒåŒ…è¿›è¡Œæµ‹è¯•ï¼Œç¡®è®¤æ— è¯¯åå†éƒ¨ç½² production ç¯å¢ƒåŒ…ã€‚
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: AI-CloudOps ${{ steps.tag_info.outputs.tag_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            dist/*.zip
            dist/packages-info.txt
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "ğŸ‰ Release ${{ steps.tag_info.outputs.tag_name }} åˆ›å»ºæˆåŠŸ!"
          echo ""
          echo "ğŸ“¦ å‘å¸ƒçš„æºä»£ç åŒ…:"
          cd dist
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              size=$(ls -lh "$zip" | awk '{print $5}')
              echo "  âœ… $zip ($size)"
            fi
          done
          echo ""
          echo "ğŸ“Š åŒ…è¯¦æƒ…: packages-info.txt"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/GoSimplicity/AI-CloudOps/releases/tag/${{ steps.tag_info.outputs.tag_name }}"
