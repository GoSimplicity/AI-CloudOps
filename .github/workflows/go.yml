name: CI/CD Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.24.2'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    name: Test & Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files are not formatted:"
            gofmt -s -l .
            exit 1
          fi

      - name: Install staticcheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        run: staticcheck ./...

      - name: Install gosec
        run: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest

      - name: Run gosec security scan
        run: gosec ./...

      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out ./... 2>&1 | tee test_results.txt
          echo "TEST_EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV

      - name: Test Summary
        run: |
          echo "### ğŸ§ª æµ‹è¯•ç»“æœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 test_results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Coverage Summary
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}')
          echo "### ğŸ“Š ä»£ç è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¦†ç›–ç‡**: $COVERAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“‹ è¦†ç›–ç‡è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | head -10 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # æ„å»ºæ£€æŸ¥
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build verification
        run: |
          echo "ğŸ”¨ éªŒè¯ä»£ç æ„å»º..."
          
          # Build for current platform (Linux amd64 on GitHub Actions)
          echo "æ„å»ºéªŒè¯ Linux amd64..."
          go build -v -ldflags="-s -w" -o ai-cloudops-test main.go
          
          # Test cross-compilation for major platforms
          echo "éªŒè¯è·¨å¹³å°ç¼–è¯‘å…¼å®¹æ€§..."
          
          # Verify Linux arm64 compilation
          echo "éªŒè¯ Linux arm64 ç¼–è¯‘..."
          GOOS=linux GOARCH=arm64 go build -v -ldflags="-s -w" -o /dev/null main.go
          
          # Verify macOS compilation
          echo "éªŒè¯ macOS ç¼–è¯‘..."
          GOOS=darwin GOARCH=amd64 go build -v -ldflags="-s -w" -o /dev/null main.go
          
          # Verify Windows compilation
          echo "éªŒè¯ Windows ç¼–è¯‘..."
          GOOS=windows GOARCH=amd64 go build -v -ldflags="-s -w" -o /dev/null main.go
          
          echo "âœ… æ‰€æœ‰å¹³å°ç¼–è¯‘éªŒè¯é€šè¿‡"

      - name: Build Summary
        run: |
          echo "### ğŸ—ï¸ æ„å»ºéªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æ¶æ„ | ç¼–è¯‘çŠ¶æ€ | ç”¨é€” |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | amd64 | âœ… | ä¸»è¦éƒ¨ç½²å¹³å° |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | arm64 | âœ… | ARMæœåŠ¡å™¨æ”¯æŒ |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | amd64 | âœ… | å¼€å‘ç¯å¢ƒæ”¯æŒ |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | amd64 | âœ… | Windowså…¼å®¹æ€§ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ’¡ è¯´æ˜**: æ„å»ºéªŒè¯ç¡®ä¿æºä»£ç å¯ä»¥åœ¨å„å¹³å°æ­£å¸¸ç¼–è¯‘" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“¦ å‘å¸ƒ**: æºä»£ç åŒ…å°†åœ¨æ‰“tagæ—¶è‡ªåŠ¨åˆ›å»ºRelease" >> $GITHUB_STEP_SUMMARY
          
          # Clean up test binary
          rm -f ai-cloudops-test

  # å®‰å…¨æ‰«æ
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ä¾èµ–æ£€æŸ¥
  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
